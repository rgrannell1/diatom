#! /usr/bin/env sh

if ! hash yq 2> /dev/null
then
  echo "yq could not be found on PATH"
  exit 1
fi

if ! hash fzf 2> /dev/null
then
  echo "fzf could not be found on PATH"
  exit 1
fi



VAULT=$(cat ~/.config/diatom.yaml | yq '.vault')


if [ "$OSTYPE" = 'linux' ]
then
  query_selection_pair="$(ls --quoting-style=literal "$VAULT" | fzf --tac --print-query --exact --preview="batcat --color always --language markdown $VAULT/{}")"
else
  query_selection_pair="$(ls "$VAULT" | fzf --tac --print-query --exact --preview="batcat --color always --language markdown $VAULT/{}")"
fi


query=$(echo "$query_selection_pair" | sed -n '1 p')
selection=$(echo "$query_selection_pair" | sed -n '2 p')


if [ -z "$query" ] && [ -z "$selection" ]
then
  echo 'no input or selection provided'
  exit 1
elif [ -z "$selection" ];
then
  # -- nothing selected, create a new file

  di new note "$query" "$@"
else
  # -- open selected file

  di open note "$selection" "$@"
fi
